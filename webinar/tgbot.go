package webinar

import (
	"context"
	"encoding/json"
	"fmt"
	"github.com/go-telegram/bot"
	"log"
	"os"
	"os/signal"
	"strings"
	"time"
)

const (
	botToken = "780504069:AAH7Ld_hobbvEkCZi8fpdKUIEXirpG4raCQ"
	dataFile = "telegramContactsCrmConsulting.json"
)

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∏–µ–Ω—Ç–∞
type Client struct {
	UserID    int64  `json:"user_id"`
	FirstName string `json:"first_name"`
	LastName  string `json:"last_name"`
	Username  string `json:"username"`
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –º–∞–ø–∞ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
var uniqueClients map[int64]Client

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
func StartTgBot() {
	log.Println("Starting Telegram Bot")

	ctx, cancel := signal.NotifyContext(context.Background(), os.Interrupt)
	defer cancel()

	opts := []bot.Option{
		bot.WithDefaultHandler(Handler),
	}

	b, err := bot.New(botToken, opts...)
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –±–æ—Ç–∞: %v", err)
	}

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
	loadUniqueClients()

	// –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
	go ScheduleMessages(b)

	b.Start(ctx)
	log.Println("b.ID():", b.ID())
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –ø–∞–º—è—Ç—å
func loadUniqueClients() {
	file, err := os.ReadFile(dataFile)
	if err != nil {
		log.Printf("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: %v", err)
		return
	}

	var clients []Client
	if err := json.Unmarshal(file, &clients); err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON: %v", err)
	}

	uniqueClients = make(map[int64]Client)
	for _, client := range clients {
		uniqueClients[client.UserID] = client
	}

	log.Printf("–ó–∞–≥—Ä—É–∂–µ–Ω–æ %d —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", len(uniqueClients))
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –≤ JSON, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
func saveClientData(client Client) {
	clients := loadClients()

	// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
	clients = append(clients, client)

	// –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º JSON-—Ñ–∞–π–ª —Å –º–∞—Å—Å–∏–≤–æ–º (–≤–∞–ª–∏–¥–Ω—ã–π JSON)
	file, err := os.OpenFile(dataFile, os.O_CREATE|os.O_WRONLY|os.O_TRUNC, 0644)
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞: %v", err)
		return
	}
	defer file.Close()

	encoder := json.NewEncoder(file)
	encoder.SetIndent("", "  ") // –ö—Ä–∞—Å–∏–≤—ã–π JSON —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
	err = encoder.Encode(clients)
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª: %v", err)
	}
}

func loadClients() []Client {
	var clients []Client

	file, err := os.ReadFile(dataFile)
	if err != nil {
		if os.IsNotExist(err) {
			return []Client{} // –§–∞–π–ª –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω
		}
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: %v", err)
		return []Client{}
	}

	err = json.Unmarshal(file, &clients)
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON: %v", err)
		return []Client{}
	}

	return clients
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
func sendMessageToClients(b *bot.Bot, messageTemplate string) {
	ctx := context.Background()
	for userID, client := range uniqueClients {
		var message string
		if strings.Contains(messageTemplate, "%s") {
			message = fmt.Sprintf(messageTemplate, client.FirstName)
		} else {
			message = messageTemplate
		}

		log.Printf("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d: %s", userID, message)

		_, err := b.SendMessage(ctx, &bot.SendMessageParams{
			ChatID:    userID,
			Text:      message,
			ParseMode: "MarkdownV2",
		})
		if err != nil {
			log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d: %v", userID, err)
		} else {
			log.Printf("–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é %d", userID)
		}
	}
}

// –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
func ScheduleMessages(b *bot.Bot) {
	for {
		now := time.Now().Format("15:04") // –í—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ß–ß:–ú–ú

		switch now {
		case "09:00":
			sendMessageToClients(b, `*–í–µ–±–∏–Ω–∞—Ä —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞\! –ö–∞–∫ CRM \+ AI —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –ø—Ä–∏–±—ã–ª—å\?*

%s, –¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ\!

–ù–∞ —Å–≤—è–∑–∏ –∫–æ–º–∞–Ω–¥–∞ CRM Consulting, —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞ –º—ã —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–¥–∞–∂–∏, –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ç–µ—Ä—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–±—ã–ª—å —Å –ø–æ–º–æ—â—å—é CRM –∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞\.

–í–æ—Ç —á—Ç–æ –≤—ã —É–∑–Ω–∞–µ—Ç–µ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä–µ:
‚Ä¢ –ö–∞–∫ CRM \+ AI –ø–æ–º–æ–≥–∞—é—Ç –Ω–µ —Ç–µ—Ä—è—Ç—å –¥–æ 40%% –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∑–∞—è–≤–æ–∫, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ follow\-up\'—ã\.
‚Ä¢ –ü–æ—á–µ–º—É CRM ‚Äì —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–æ—Å—Ç–∞ ‚Äì —Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã, –∫–∞–∫ –±–∏–∑–Ω–µ—Å—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –≤—ã—Ä—É—á–∫—É –Ω–∞ 30\-50%%\.
‚Ä¢ –ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–¥–µ–ª –ø—Ä–æ–¥–∞–∂, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ö–∞–æ—Å–∞ ‚Äì CRM –ø–æ–º–æ–∂–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å —á—ë—Ç–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã\.

–ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å –≤–æ–≤—Ä–µ–º—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ\!
üëâ [–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å –∫ –≤–µ–±–∏–Ω–∞—Ä—É –∑–¥–µ—Å—å](https://us06web.zoom.us/j/89326719994?pwd=GysR7TlRgW0l1lSIUqGEzj016yZ1jU.1)

–°–∫–æ—Ä–æ —É–≤–∏–¥–∏–º—Å—è –≤ —ç—Ñ–∏—Ä–µ\!
–ö–æ–º–∞–Ω–¥–∞ CRM Consulting`)
		case "10:50":
			sendMessageToClients(b, `*–û—Å—Ç–∞–ª–æ—Å—å 10 –º–∏–Ω—É—Ç –∏ –Ω–∞—á–∏–Ω–∞–µ–º\. –ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å*

%s, —É–∂–µ —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç —Ä–∞–∑–±–µ—Ä–µ–º, –∫–∞–∫ CRM \+ AI –º–æ–≥—É—Ç –∑–∞–∫—Ä—ã—Ç—å –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–∏–∑–Ω–µ—Å–∞ –∏ –ø–æ–º–æ—á—å –≤–∞–º –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–µ\!

–í–∞–º –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–æ, –µ—Å–ª–∏\:

‚Ä¢ *–ú–µ–Ω–µ–¥–∂–µ—Ä—ã —Ç–µ—Ä—è—é—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤* ‚Äì –∑–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å –æ–ø–æ–∑–¥–∞–Ω–∏–µ–º, –∫–ª–∏–µ–Ω—Ç—ã —É—Ö–æ–¥—è—Ç –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º\.
‚Ä¢ *–ù–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–æ–¥–∞–∂–∞—Ö* ‚Äì —Å–ª–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ —Å–¥–µ–ª–∫–∏, –∫—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á–∏ –∏ –≥–¥–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞\.
‚Ä¢ *–°–ª–∞–±—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ –∫–æ–º–∞–Ω–¥–æ–π* ‚Äì –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\.
‚Ä¢ *–†—É—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç –±–∏–∑–Ω–µ—Å* ‚Äì –æ—Ç—á—ë—Ç—ã, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –ø–∏—Å—å–º–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –¥–µ–ª–∞—é—Ç –≤—Ä—É—á–Ω—É—é –≤–º–µ—Å—Ç–æ –ø—Ä–æ–¥–∞–∂\.
‚Ä¢ CRM –µ—Å—Ç—å, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–ø–æ–ª—Å–∏–ª—ã –∏–ª–∏ –≤—ã –∑–∞–¥—É–º—ã–≤–∞–µ—Ç–µ—Å—å –æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏\.

üî• –°–µ–≥–æ–¥–Ω—è —Ä–∞–∑–±–µ—Ä—ë–º, –∫–∞–∫ CRM \+ AI —Ä–µ—à–∞—é—Ç —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–≤—Ä–∞—â–∞—é—Ç —Ö–∞–æ—Å –≤ —Å–∏—Å—Ç–µ–º—É, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ–¥–∞–µ—Ç\!

[–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ](https://us06web.zoom.us/j/89326719994?pwd=GysR7TlRgW0l1lSIUqGEzj016yZ1jU.1)`)
		case "11:00":
			sendMessageToClients(b, `*3\.\.\.2\.\.\.1\.\.\. –ú—ã –≤ —ç—Ñ–∏—Ä–µ\! –ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å\!*

–ú—ã —É–∂–µ –Ω–∞—á–∞–ª–∏ –≤–µ–±–∏–Ω–∞—Ä\! *–ö–∞–∫ CRM \+ AI —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç –ø—Ä–æ–¥–∞–∂–∏, —Å–æ–∫—Ä–∞—â–∞—é—Ç –ø–æ—Ç–µ—Ä–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä—É—é—Ç –±–∏–∑–Ω–µ—Å\?* –†–∞–∑–±–µ—Ä–µ–º –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å\!

–û–±—Å—É–¥–∏–º –±–µ–∑ –≤–æ–¥—ã: –∫–∞–∫ –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ç–µ—Ä—è—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–∏–±—ã–ª—å —Å CRM, –∫–∞–∫–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É–∂–µ —Å–µ–π—á–∞—Å, —Ä–µ–∞–ª—å–Ω—ã–µ –∫–µ–π—Å—ã –∫–æ–º–ø–∞–Ω–∏–π,
–∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–∞—à–∏ –∫–ª–∏–µ–Ω—Ç—ã\.

–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å üëâ [–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä](https://us06web.zoom.us/j/89326719994?pwd=GysR7TlRgW0l1lSIUqGEzj016yZ1jU.1)

–ù–µ —É–ø—É—Å—Ç–∏—Ç–µ, —Ç–æ —á—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–æ \- –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Ç–µ—Å—å\!`)
		case "11:15":
			sendMessageToClients(b, `*–ö–∞–∫ –ø–æ–¥—Ä—É–∂–∏—Ç—å CRM –∏ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç\?*

–ú–∏—Ö–∞–∏–ª, –±–∏–∑–Ω–µ—Å\-–∞–Ω–∞–ª–∏—Ç–∏–∫ CRM Consulting —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –≤ —ç—Ñ–∏—Ä–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å, —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –∏ —É–≤–µ–ª–∏—á–∏—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –≤ –±–∏–∑–Ω–µ—Å–µ —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞\.

–ó–∞—Ö–æ–¥–∏—Ç–µ üëâ [–°—Å—ã–ª–∫–∞](https://us06web.zoom.us/j/89326719994?pwd=GysR7TlRgW0l1lSIUqGEzj016yZ1jU.1)
`)
		case "11:30":
			sendMessageToClients(b, `*üî• –°–Ω–∏–∑–∏–ª–∏ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ Call\-—Ü–µ–Ω—Ç—Ä –≤ 10 —Ä–∞–∑\! –° –ø–æ–º–æ—â—å—é –ò–ò*

–°–µ–≥–æ–¥–Ω—è –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä–µ –º—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –ò–ò \+ CRM\.

–ü–æ–¥–∫–ª—é—á–∞–π—Ç–µ—Å—å, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫ –∫–æ–º–ø–∞–Ω–∏—è –æ—Ç–∫–∞–∑–∞–ª–∞—Å—å –æ—Ç Call\-—Ü–µ–Ω—Ç—Ä–∞ –Ω–∞ –∞—É—Ç—Å–æ—Ä—Å–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–º—É –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É\.

–ñ–¥–µ–º –≤–∞—Å: üëâ [–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±–∏–Ω–∞—Ä](https://us06web.zoom.us/j/89326719994?pwd=GysR7TlRgW0l1lSIUqGEzj016yZ1jU.1)
`)
		}

		time.Sleep(time.Until(time.Now().Truncate(time.Minute).Add(time.Minute)))
	}
}
